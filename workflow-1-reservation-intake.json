{
  "name": "북막골_예약접수및확정",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "bookmakgol-reservation",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "5e6b3c4a-8f2d-4e1b-9c3a-1f7b8d9e0a2b",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        240,
        300
      ],
      "webhookId": "bookmakgol-reservation"
    },
    {
      "parameters": {
        "functionCode": "// 데이터 검증 및 변환\nconst data = items[0].json;\n\n// 필수 항목 체크\nconst requiredFields = ['branch', 'date', 'time', 'spaceType', 'guests', 'name', 'phone', 'email', 'language'];\nconst missingFields = [];\n\nfor (const field of requiredFields) {\n  if (!data[field] || data[field].toString().trim() === '') {\n    missingFields.push(field);\n  }\n}\n\nif (missingFields.length > 0) {\n  return [{\n    json: {\n      error: true,\n      message: `Missing required fields: ${missingFields.join(', ')}`\n    }\n  }];\n}\n\n// 이메일 형식 검증\nconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\nif (!emailRegex.test(data.email)) {\n  return [{\n    json: {\n      error: true,\n      message: 'Invalid email format'\n    }\n  }];\n}\n\n// 날짜/시간 형식 변환\nconst dateTime = `${data.date}T${data.time}:00.000+07:00`; // Bangkok timezone\n\n// 예약번호 생성용 날짜 (YYYYMMDD)\nconst bookingDate = data.date.replace(/-/g, '');\n\n// 공간 정보 설정\nlet roomNumber = null;\nlet floor = null;\n\nif (data.spaceType === '룸') {\n  roomNumber = data.spaceDetail;\n} else {\n  floor = data.spaceDetail;\n}\n\nreturn [{\n  json: {\n    ...data,\n    dateTime: dateTime,\n    bookingDate: bookingDate,\n    roomNumber: roomNumber,\n    floor: floor,\n    status: '예약대기',\n    reminderSent: false,\n    error: false\n  }\n}];"
      },
      "id": "2f8a9b1c-3d4e-5f6a-7b8c-9d0e1f2a3b4c",
      "name": "데이터 검증",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        440,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.error}}",
              "value2": true
            }
          ]
        }
      },
      "id": "3c5d7e9f-1a2b-3c4d-5e6f-7a8b9c0d1e2f",
      "name": "검증 오류 체크",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        640,
        300
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"error\",\n  \"message\": \"{{$json.message}}\"\n}",
        "options": {}
      },
      "id": "4d6e8f0a-2b3c-4d5e-6f7a-8b9c0d1e2f3a",
      "name": "오류 응답",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        840,
        200
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": "284a2fb1-c15d-81a1-9d93-d4f47300f2e3",
        "returnAll": false,
        "limit": 100,
        "filterType": "manual",
        "matchType": "and",
        "filters": {
          "conditions": [
            {
              "key": "예약일시",
              "condition": "equals",
              "value": "={{$json.dateTime}}"
            },
            {
              "key": "지점",
              "condition": "equals",
              "value": "={{$json.branch}}"
            },
            {
              "key": "공간유형",
              "condition": "equals",
              "value": "룸"
            },
            {
              "key": "상태",
              "condition": "not_equals",
              "value": "취소"
            }
          ]
        }
      },
      "id": "5e7f9a0b-3c4d-5e6f-7a8b-9c0d1e2f3a4b",
      "name": "중복 예약 체크",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [
        840,
        400
      ]
    },
    {
      "parameters": {
        "functionCode": "// 룸 예약인 경우에만 중복 체크\nconst inputData = items[0].json;\nconst existingReservations = items.slice(1).map(item => item.json);\n\nif (inputData.spaceType !== '룸') {\n  // 홀 예약은 중복 체크 안 함\n  return [{\n    json: {\n      ...inputData,\n      duplicateFound: false\n    }\n  }];\n}\n\n// 룸 예약 중복 체크\nconst duplicates = existingReservations.filter(reservation => {\n  return reservation.properties['룸번호'].select?.name === inputData.roomNumber;\n});\n\nif (duplicates.length > 0) {\n  return [{\n    json: {\n      ...inputData,\n      duplicateFound: true,\n      duplicateMessage: `${inputData.branch} ${inputData.roomNumber}은(는) ${inputData.date} ${inputData.time}에 이미 예약되어 있습니다.`\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    ...inputData,\n    duplicateFound: false\n  }\n}];"
      },
      "id": "6f8a9b0c-4d5e-6f7a-8b9c-0d1e2f3a4b5c",
      "name": "중복 검사 로직",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1040,
        400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.duplicateFound}}",
              "value2": true
            }
          ]
        }
      },
      "id": "7a9b0c1d-5e6f-7a8b-9c0d-1e2f3a4b5c6d",
      "name": "중복 예약 확인",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1240,
        400
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"error\",\n  \"message\": \"{{$json.duplicateMessage}}\"\n}",
        "options": {}
      },
      "id": "8b0c1d2e-6f7a-8b9c-0d1e-2f3a4b5c6d7e",
      "name": "중복 오류 응답",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1440,
        300
      ]
    },
    {
      "parameters": {
        "functionCode": "// 예약번호 생성\nconst data = items[0].json;\nconst bookingDate = data.bookingDate;\n\n// 시퀀스 번호는 간단히 현재 시간의 밀리초를 사용\nconst sequence = String(Date.now()).slice(-3);\nconst bookingNumber = `BOOK-${bookingDate}-${sequence}`;\n\nreturn [{\n  json: {\n    ...data,\n    bookingNumber: bookingNumber\n  }\n}];"
      },
      "id": "9c1d2e3f-7a8b-9c0d-1e2f-3a4b5c6d7e8f",
      "name": "예약번호 생성",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1440,
        500
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "create",
        "databaseId": "284a2fb1-c15d-81a1-9d93-d4f47300f2e3",
        "title": "={{$json.bookingNumber}}",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "예약일시",
              "dateValue": "={{$json.dateTime}}"
            },
            {
              "key": "지점",
              "selectValue": "={{$json.branch}}"
            },
            {
              "key": "공간유형",
              "selectValue": "={{$json.spaceType}}"
            },
            {
              "key": "룸번호",
              "selectValue": "={{$json.roomNumber}}"
            },
            {
              "key": "층",
              "selectValue": "={{$json.floor}}"
            },
            {
              "key": "인원",
              "numberValue": "={{$json.guests}}"
            },
            {
              "key": "이름",
              "textValue": "={{$json.name}}"
            },
            {
              "key": "전화번호",
              "phoneValue": "={{$json.phone}}"
            },
            {
              "key": "이메일",
              "emailValue": "={{$json.email}}"
            },
            {
              "key": "언어",
              "selectValue": "={{$json.language === 'ko' ? 'Korean' : $json.language === 'th' ? 'Thai' : 'English'}}"
            },
            {
              "key": "특별요청",
              "textValue": "={{$json.specialRequest}}"
            },
            {
              "key": "상태",
              "selectValue": "예약대기"
            },
            {
              "key": "리마인더발송",
              "checkboxValue": false
            }
          ]
        }
      },
      "id": "0d2e3f4a-8b9c-0d1e-2f3a-4b5c6d7e8f9a",
      "name": "Notion에 저장",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [
        1640,
        500
      ]
    },
    {
      "parameters": {
        "functionCode": "// 관리자 이메일 템플릿 (HTML 버튼 포함)\nconst data = items[0].json;\n\nconst branchInfo = {\n  'Ekamai': {\n    name: '에까마이 지점',\n    phone: '095-868-6826',\n    address: '에카마이 BTS 4번 출구, 수쿰윗 병원 맞은편'\n  },\n  'Phrom Phong': {\n    name: '프롬퐁 지점', \n    phone: '02-115-5500',\n    address: '수쿰윗 소이 24, 아리스톤 호텔 1층'\n  }\n};\n\nconst branch = branchInfo[data.branch];\nconst dateFormatted = new Date(data.dateTime).toLocaleString('ko-KR', {\n  timeZone: 'Asia/Bangkok',\n  year: 'numeric',\n  month: '2-digit', \n  day: '2-digit',\n  hour: '2-digit',\n  minute: '2-digit'\n});\n\nconst spaceInfo = data.spaceType === 'Room' ? `룸 - ${data.roomNumber}` : `홀 - ${data.floor}`;\n\n// n8n Webhook URLs (실제 URL로 교체 필요)\nconst confirmUrl = `YOUR_N8N_WEBHOOK_URL/confirm?id=${data.bookingNumber}`;\nconst cancelUrl = `YOUR_N8N_WEBHOOK_URL/cancel?id=${data.bookingNumber}`;\n\nconst emailBody = `\n<html>\n<body style=\"font-family: Arial, sans-serif; color: #333; line-height: 1.6;\">\n\n<h2 style=\"color: #8b4513;\">🍽️ 새로운 예약이 접수되었습니다</h2>\n\n<div style=\"background: #f9f9f9; padding: 20px; border-radius: 10px; margin: 20px 0;\">\n<h3 style=\"color: #8b4513; border-bottom: 2px solid #8b4513; padding-bottom: 10px;\">📋 예약 정보</h3>\n<p><strong>예약번호:</strong> ${data.bookingNumber}</p>\n<p><strong>지점:</strong> ${branch.name}</p>\n<p><strong>날짜/시간:</strong> ${dateFormatted}</p>\n<p><strong>공간:</strong> ${spaceInfo}</p>\n<p><strong>인원:</strong> ${data.guests}명</p>\n</div>\n\n<div style=\"background: #f0f8ff; padding: 20px; border-radius: 10px; margin: 20px 0;\">\n<h3 style=\"color: #8b4513; border-bottom: 2px solid #8b4513; padding-bottom: 10px;\">👤 고객 정보</h3>\n<p><strong>이름:</strong> ${data.name}</p>\n<p><strong>전화:</strong> ${data.phone}</p>\n<p><strong>이메일:</strong> ${data.email}</p>\n<p><strong>언어:</strong> ${data.language}</p>\n<p><strong>특별요청:</strong> ${data.specialRequest || '없음'}</p>\n</div>\n\n<div style=\"text-align: center; margin: 30px 0;\">\n<h3 style=\"color: #8b4513;\">⚡ 원클릭 처리</h3>\n<p style=\"margin-bottom: 20px;\">아래 버튼을 클릭하여 바로 처리하세요!</p>\n\n<a href=\"${confirmUrl}\" style=\"display: inline-block; background: #28a745; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; margin: 0 10px; font-weight: bold; font-size: 16px;\">✅ 예약 확정</a>\n\n<a href=\"${cancelUrl}\" style=\"display: inline-block; background: #dc3545; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; margin: 0 10px; font-weight: bold; font-size: 16px;\">❌ 예약 취소</a>\n</div>\n\n<div style=\"background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;\">\n<p><strong>📱 모바일에서도 간편하게!</strong></p>\n<p>• 확정 버튼 클릭 → 고객에게 자동 확정 이메일 발송</p>\n<p>• 취소 버튼 클릭 → 고객에게 자동 취소 알림 발송</p>\n<p>• Notion 접속 불필요!</p>\n</div>\n\n<hr style=\"margin: 30px 0; border: none; border-top: 1px solid #ddd;\">\n<p style=\"color: #666; font-size: 14px; text-align: center;\">\n북막골 예약 관리 시스템<br>\n문제가 있으시면 개발자에게 연락주세요.\n</p>\n\n</body>\n</html>\n`;\n\nreturn [{\n  json: {\n    ...data,\n    adminEmailSubject: `[북막골] 새 예약 - ${branch.name} - ${dateFormatted}`,\n    adminEmailBody: emailBody,\n    confirmUrl: confirmUrl,\n    cancelUrl: cancelUrl\n  }\n}];"
      },
      "id": "1e3f4a5b-9c0d-1e2f-3a4b-5c6d7e8f9a0b",
      "name": "관리자 이메일 생성",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1840,
        500
      ]
    },
    {
      "parameters": {
        "sendTo": "RESTAURANT_ADMIN_EMAIL@example.com",
        "subject": "={{$json.adminEmailSubject}}",
        "emailType": "html",
        "message": "={{$json.adminEmailBody}}",
        "options": {}
      },
      "id": "2f4a5b6c-0d1e-2f3a-4b5c-6d7e8f9a0b1c",
      "name": "관리자 이메일 발송",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 1,
      "position": [
        2040,
        500
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"success\",\n  \"bookingNumber\": \"{{$json.bookingNumber}}\",\n  \"message\": \"예약이 성공적으로 접수되었습니다. 확정 후 이메일로 안내드리겠습니다.\"\n}",
        "options": {}
      },
      "id": "3a5b6c7d-1e2f-3a4b-5c6d-7e8f9a0b1c2d",
      "name": "성공 응답",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        2240,
        500
      ]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "데이터 검증",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "데이터 검증": {
      "main": [
        [
          {
            "node": "검증 오류 체크",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "검증 오류 체크": {
      "main": [
        [
          {
            "node": "오류 응답",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "중복 예약 체크",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "중복 예약 체크": {
      "main": [
        [
          {
            "node": "중복 검사 로직",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "중복 검사 로직": {
      "main": [
        [
          {
            "node": "중복 예약 확인",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "중복 예약 확인": {
      "main": [
        [
          {
            "node": "중복 오류 응답",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "예약번호 생성",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "예약번호 생성": {
      "main": [
        [
          {
            "node": "Notion에 저장",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notion에 저장": {
      "main": [
        [
          {
            "node": "관리자 이메일 생성",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "관리자 이메일 생성": {
      "main": [
        [
          {
            "node": "관리자 이메일 발송",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "관리자 이메일 발송": {
      "main": [
        [
          {
            "node": "성공 응답",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "timezone": "Asia/Bangkok"
  },
  "versionId": "1",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "bookmakgol-reservation-intake",
  "tags": []
}
