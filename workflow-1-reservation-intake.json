{
  "name": "ë¶ë§‰ê³¨_ì˜ˆì•½ì ‘ìˆ˜ë°í™•ì •",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "bookmakgol-reservation",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "5e6b3c4a-8f2d-4e1b-9c3a-1f7b8d9e0a2b",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        240,
        300
      ],
      "webhookId": "bookmakgol-reservation"
    },
    {
      "parameters": {
        "functionCode": "// ë°ì´í„° ê²€ì¦ ë° ë³€í™˜\nconst data = items[0].json;\n\n// í•„ìˆ˜ í•­ëª© ì²´í¬\nconst requiredFields = ['branch', 'date', 'time', 'spaceType', 'guests', 'name', 'phone', 'email', 'language'];\nconst missingFields = [];\n\nfor (const field of requiredFields) {\n  if (!data[field] || data[field].toString().trim() === '') {\n    missingFields.push(field);\n  }\n}\n\nif (missingFields.length > 0) {\n  return [{\n    json: {\n      error: true,\n      message: `Missing required fields: ${missingFields.join(', ')}`\n    }\n  }];\n}\n\n// ì´ë©”ì¼ í˜•ì‹ ê²€ì¦\nconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\nif (!emailRegex.test(data.email)) {\n  return [{\n    json: {\n      error: true,\n      message: 'Invalid email format'\n    }\n  }];\n}\n\n// ë‚ ì§œ/ì‹œê°„ í˜•ì‹ ë³€í™˜\nconst dateTime = `${data.date}T${data.time}:00.000+07:00`; // Bangkok timezone\n\n// ì˜ˆì•½ë²ˆí˜¸ ìƒì„±ìš© ë‚ ì§œ (YYYYMMDD)\nconst bookingDate = data.date.replace(/-/g, '');\n\n// ê³µê°„ ì •ë³´ ì„¤ì •\nlet roomNumber = null;\nlet floor = null;\n\nif (data.spaceType === 'ë£¸') {\n  roomNumber = data.spaceDetail;\n} else {\n  floor = data.spaceDetail;\n}\n\nreturn [{\n  json: {\n    ...data,\n    dateTime: dateTime,\n    bookingDate: bookingDate,\n    roomNumber: roomNumber,\n    floor: floor,\n    status: 'ì˜ˆì•½ëŒ€ê¸°',\n    reminderSent: false,\n    error: false\n  }\n}];"
      },
      "id": "2f8a9b1c-3d4e-5f6a-7b8c-9d0e1f2a3b4c",
      "name": "ë°ì´í„° ê²€ì¦",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        440,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.error}}",
              "value2": true
            }
          ]
        }
      },
      "id": "3c5d7e9f-1a2b-3c4d-5e6f-7a8b9c0d1e2f",
      "name": "ê²€ì¦ ì˜¤ë¥˜ ì²´í¬",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        640,
        300
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"error\",\n  \"message\": \"{{$json.message}}\"\n}",
        "options": {}
      },
      "id": "4d6e8f0a-2b3c-4d5e-6f7a-8b9c0d1e2f3a",
      "name": "ì˜¤ë¥˜ ì‘ë‹µ",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        840,
        200
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": "284a2fb1-c15d-81a1-9d93-d4f47300f2e3",
        "returnAll": false,
        "limit": 100,
        "filterType": "manual",
        "matchType": "and",
        "filters": {
          "conditions": [
            {
              "key": "ì˜ˆì•½ì¼ì‹œ",
              "condition": "equals",
              "value": "={{$json.dateTime}}"
            },
            {
              "key": "ì§€ì ",
              "condition": "equals",
              "value": "={{$json.branch}}"
            },
            {
              "key": "ê³µê°„ìœ í˜•",
              "condition": "equals",
              "value": "ë£¸"
            },
            {
              "key": "ìƒíƒœ",
              "condition": "not_equals",
              "value": "ì·¨ì†Œ"
            }
          ]
        }
      },
      "id": "5e7f9a0b-3c4d-5e6f-7a8b-9c0d1e2f3a4b",
      "name": "ì¤‘ë³µ ì˜ˆì•½ ì²´í¬",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [
        840,
        400
      ]
    },
    {
      "parameters": {
        "functionCode": "// ë£¸ ì˜ˆì•½ì¸ ê²½ìš°ì—ë§Œ ì¤‘ë³µ ì²´í¬\nconst inputData = items[0].json;\nconst existingReservations = items.slice(1).map(item => item.json);\n\nif (inputData.spaceType !== 'ë£¸') {\n  // í™€ ì˜ˆì•½ì€ ì¤‘ë³µ ì²´í¬ ì•ˆ í•¨\n  return [{\n    json: {\n      ...inputData,\n      duplicateFound: false\n    }\n  }];\n}\n\n// ë£¸ ì˜ˆì•½ ì¤‘ë³µ ì²´í¬\nconst duplicates = existingReservations.filter(reservation => {\n  return reservation.properties['ë£¸ë²ˆí˜¸'].select?.name === inputData.roomNumber;\n});\n\nif (duplicates.length > 0) {\n  return [{\n    json: {\n      ...inputData,\n      duplicateFound: true,\n      duplicateMessage: `${inputData.branch} ${inputData.roomNumber}ì€(ëŠ”) ${inputData.date} ${inputData.time}ì— ì´ë¯¸ ì˜ˆì•½ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    ...inputData,\n    duplicateFound: false\n  }\n}];"
      },
      "id": "6f8a9b0c-4d5e-6f7a-8b9c-0d1e2f3a4b5c",
      "name": "ì¤‘ë³µ ê²€ì‚¬ ë¡œì§",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1040,
        400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.duplicateFound}}",
              "value2": true
            }
          ]
        }
      },
      "id": "7a9b0c1d-5e6f-7a8b-9c0d-1e2f3a4b5c6d",
      "name": "ì¤‘ë³µ ì˜ˆì•½ í™•ì¸",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1240,
        400
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"error\",\n  \"message\": \"{{$json.duplicateMessage}}\"\n}",
        "options": {}
      },
      "id": "8b0c1d2e-6f7a-8b9c-0d1e-2f3a4b5c6d7e",
      "name": "ì¤‘ë³µ ì˜¤ë¥˜ ì‘ë‹µ",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1440,
        300
      ]
    },
    {
      "parameters": {
        "functionCode": "// ì˜ˆì•½ë²ˆí˜¸ ìƒì„±\nconst data = items[0].json;\nconst bookingDate = data.bookingDate;\n\n// ì‹œí€€ìŠ¤ ë²ˆí˜¸ëŠ” ê°„ë‹¨íˆ í˜„ì¬ ì‹œê°„ì˜ ë°€ë¦¬ì´ˆë¥¼ ì‚¬ìš©\nconst sequence = String(Date.now()).slice(-3);\nconst bookingNumber = `BOOK-${bookingDate}-${sequence}`;\n\nreturn [{\n  json: {\n    ...data,\n    bookingNumber: bookingNumber\n  }\n}];"
      },
      "id": "9c1d2e3f-7a8b-9c0d-1e2f-3a4b5c6d7e8f",
      "name": "ì˜ˆì•½ë²ˆí˜¸ ìƒì„±",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1440,
        500
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "create",
        "databaseId": "284a2fb1-c15d-81a1-9d93-d4f47300f2e3",
        "title": "={{$json.bookingNumber}}",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "ì˜ˆì•½ì¼ì‹œ",
              "dateValue": "={{$json.dateTime}}"
            },
            {
              "key": "ì§€ì ",
              "selectValue": "={{$json.branch}}"
            },
            {
              "key": "ê³µê°„ìœ í˜•",
              "selectValue": "={{$json.spaceType}}"
            },
            {
              "key": "ë£¸ë²ˆí˜¸",
              "selectValue": "={{$json.roomNumber}}"
            },
            {
              "key": "ì¸µ",
              "selectValue": "={{$json.floor}}"
            },
            {
              "key": "ì¸ì›",
              "numberValue": "={{$json.guests}}"
            },
            {
              "key": "ì´ë¦„",
              "textValue": "={{$json.name}}"
            },
            {
              "key": "ì „í™”ë²ˆí˜¸",
              "phoneValue": "={{$json.phone}}"
            },
            {
              "key": "ì´ë©”ì¼",
              "emailValue": "={{$json.email}}"
            },
            {
              "key": "ì–¸ì–´",
              "selectValue": "={{$json.language === 'ko' ? 'Korean' : $json.language === 'th' ? 'Thai' : 'English'}}"
            },
            {
              "key": "íŠ¹ë³„ìš”ì²­",
              "textValue": "={{$json.specialRequest}}"
            },
            {
              "key": "ìƒíƒœ",
              "selectValue": "ì˜ˆì•½ëŒ€ê¸°"
            },
            {
              "key": "ë¦¬ë§ˆì¸ë”ë°œì†¡",
              "checkboxValue": false
            }
          ]
        }
      },
      "id": "0d2e3f4a-8b9c-0d1e-2f3a-4b5c6d7e8f9a",
      "name": "Notionì— ì €ì¥",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [
        1640,
        500
      ]
    },
    {
      "parameters": {
        "functionCode": "// ê´€ë¦¬ì ì´ë©”ì¼ í…œí”Œë¦¿ (HTML ë²„íŠ¼ í¬í•¨)\nconst data = items[0].json;\n\nconst branchInfo = {\n  'Ekamai': {\n    name: 'ì—ê¹Œë§ˆì´ ì§€ì ',\n    phone: '095-868-6826',\n    address: 'ì—ì¹´ë§ˆì´ BTS 4ë²ˆ ì¶œêµ¬, ìˆ˜ì¿°ìœ— ë³‘ì› ë§ì€í¸'\n  },\n  'Phrom Phong': {\n    name: 'í”„ë¡¬í ì§€ì ', \n    phone: '02-115-5500',\n    address: 'ìˆ˜ì¿°ìœ— ì†Œì´ 24, ì•„ë¦¬ìŠ¤í†¤ í˜¸í…” 1ì¸µ'\n  }\n};\n\nconst branch = branchInfo[data.branch];\nconst dateFormatted = new Date(data.dateTime).toLocaleString('ko-KR', {\n  timeZone: 'Asia/Bangkok',\n  year: 'numeric',\n  month: '2-digit', \n  day: '2-digit',\n  hour: '2-digit',\n  minute: '2-digit'\n});\n\nconst spaceInfo = data.spaceType === 'Room' ? `ë£¸ - ${data.roomNumber}` : `í™€ - ${data.floor}`;\n\n// n8n Webhook URLs (ì‹¤ì œ URLë¡œ êµì²´ í•„ìš”)\nconst confirmUrl = `YOUR_N8N_WEBHOOK_URL/confirm?id=${data.bookingNumber}`;\nconst cancelUrl = `YOUR_N8N_WEBHOOK_URL/cancel?id=${data.bookingNumber}`;\n\nconst emailBody = `\n<html>\n<body style=\"font-family: Arial, sans-serif; color: #333; line-height: 1.6;\">\n\n<h2 style=\"color: #8b4513;\">ğŸ½ï¸ ìƒˆë¡œìš´ ì˜ˆì•½ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤</h2>\n\n<div style=\"background: #f9f9f9; padding: 20px; border-radius: 10px; margin: 20px 0;\">\n<h3 style=\"color: #8b4513; border-bottom: 2px solid #8b4513; padding-bottom: 10px;\">ğŸ“‹ ì˜ˆì•½ ì •ë³´</h3>\n<p><strong>ì˜ˆì•½ë²ˆí˜¸:</strong> ${data.bookingNumber}</p>\n<p><strong>ì§€ì :</strong> ${branch.name}</p>\n<p><strong>ë‚ ì§œ/ì‹œê°„:</strong> ${dateFormatted}</p>\n<p><strong>ê³µê°„:</strong> ${spaceInfo}</p>\n<p><strong>ì¸ì›:</strong> ${data.guests}ëª…</p>\n</div>\n\n<div style=\"background: #f0f8ff; padding: 20px; border-radius: 10px; margin: 20px 0;\">\n<h3 style=\"color: #8b4513; border-bottom: 2px solid #8b4513; padding-bottom: 10px;\">ğŸ‘¤ ê³ ê° ì •ë³´</h3>\n<p><strong>ì´ë¦„:</strong> ${data.name}</p>\n<p><strong>ì „í™”:</strong> ${data.phone}</p>\n<p><strong>ì´ë©”ì¼:</strong> ${data.email}</p>\n<p><strong>ì–¸ì–´:</strong> ${data.language}</p>\n<p><strong>íŠ¹ë³„ìš”ì²­:</strong> ${data.specialRequest || 'ì—†ìŒ'}</p>\n</div>\n\n<div style=\"text-align: center; margin: 30px 0;\">\n<h3 style=\"color: #8b4513;\">âš¡ ì›í´ë¦­ ì²˜ë¦¬</h3>\n<p style=\"margin-bottom: 20px;\">ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë°”ë¡œ ì²˜ë¦¬í•˜ì„¸ìš”!</p>\n\n<a href=\"${confirmUrl}\" style=\"display: inline-block; background: #28a745; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; margin: 0 10px; font-weight: bold; font-size: 16px;\">âœ… ì˜ˆì•½ í™•ì •</a>\n\n<a href=\"${cancelUrl}\" style=\"display: inline-block; background: #dc3545; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; margin: 0 10px; font-weight: bold; font-size: 16px;\">âŒ ì˜ˆì•½ ì·¨ì†Œ</a>\n</div>\n\n<div style=\"background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;\">\n<p><strong>ğŸ“± ëª¨ë°”ì¼ì—ì„œë„ ê°„í¸í•˜ê²Œ!</strong></p>\n<p>â€¢ í™•ì • ë²„íŠ¼ í´ë¦­ â†’ ê³ ê°ì—ê²Œ ìë™ í™•ì • ì´ë©”ì¼ ë°œì†¡</p>\n<p>â€¢ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ â†’ ê³ ê°ì—ê²Œ ìë™ ì·¨ì†Œ ì•Œë¦¼ ë°œì†¡</p>\n<p>â€¢ Notion ì ‘ì† ë¶ˆí•„ìš”!</p>\n</div>\n\n<hr style=\"margin: 30px 0; border: none; border-top: 1px solid #ddd;\">\n<p style=\"color: #666; font-size: 14px; text-align: center;\">\në¶ë§‰ê³¨ ì˜ˆì•½ ê´€ë¦¬ ì‹œìŠ¤í…œ<br>\në¬¸ì œê°€ ìˆìœ¼ì‹œë©´ ê°œë°œìì—ê²Œ ì—°ë½ì£¼ì„¸ìš”.\n</p>\n\n</body>\n</html>\n`;\n\nreturn [{\n  json: {\n    ...data,\n    adminEmailSubject: `[ë¶ë§‰ê³¨] ìƒˆ ì˜ˆì•½ - ${branch.name} - ${dateFormatted}`,\n    adminEmailBody: emailBody,\n    confirmUrl: confirmUrl,\n    cancelUrl: cancelUrl\n  }\n}];"
      },
      "id": "1e3f4a5b-9c0d-1e2f-3a4b-5c6d7e8f9a0b",
      "name": "ê´€ë¦¬ì ì´ë©”ì¼ ìƒì„±",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1840,
        500
      ]
    },
    {
      "parameters": {
        "sendTo": "RESTAURANT_ADMIN_EMAIL@example.com",
        "subject": "={{$json.adminEmailSubject}}",
        "emailType": "html",
        "message": "={{$json.adminEmailBody}}",
        "options": {}
      },
      "id": "2f4a5b6c-0d1e-2f3a-4b5c-6d7e8f9a0b1c",
      "name": "ê´€ë¦¬ì ì´ë©”ì¼ ë°œì†¡",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 1,
      "position": [
        2040,
        500
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"success\",\n  \"bookingNumber\": \"{{$json.bookingNumber}}\",\n  \"message\": \"ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. í™•ì • í›„ ì´ë©”ì¼ë¡œ ì•ˆë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\"\n}",
        "options": {}
      },
      "id": "3a5b6c7d-1e2f-3a4b-5c6d-7e8f9a0b1c2d",
      "name": "ì„±ê³µ ì‘ë‹µ",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        2240,
        500
      ]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "ë°ì´í„° ê²€ì¦",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ë°ì´í„° ê²€ì¦": {
      "main": [
        [
          {
            "node": "ê²€ì¦ ì˜¤ë¥˜ ì²´í¬",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ê²€ì¦ ì˜¤ë¥˜ ì²´í¬": {
      "main": [
        [
          {
            "node": "ì˜¤ë¥˜ ì‘ë‹µ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ì¤‘ë³µ ì˜ˆì•½ ì²´í¬",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì¤‘ë³µ ì˜ˆì•½ ì²´í¬": {
      "main": [
        [
          {
            "node": "ì¤‘ë³µ ê²€ì‚¬ ë¡œì§",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì¤‘ë³µ ê²€ì‚¬ ë¡œì§": {
      "main": [
        [
          {
            "node": "ì¤‘ë³µ ì˜ˆì•½ í™•ì¸",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì¤‘ë³µ ì˜ˆì•½ í™•ì¸": {
      "main": [
        [
          {
            "node": "ì¤‘ë³µ ì˜¤ë¥˜ ì‘ë‹µ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ì˜ˆì•½ë²ˆí˜¸ ìƒì„±",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì˜ˆì•½ë²ˆí˜¸ ìƒì„±": {
      "main": [
        [
          {
            "node": "Notionì— ì €ì¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notionì— ì €ì¥": {
      "main": [
        [
          {
            "node": "ê´€ë¦¬ì ì´ë©”ì¼ ìƒì„±",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ê´€ë¦¬ì ì´ë©”ì¼ ìƒì„±": {
      "main": [
        [
          {
            "node": "ê´€ë¦¬ì ì´ë©”ì¼ ë°œì†¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ê´€ë¦¬ì ì´ë©”ì¼ ë°œì†¡": {
      "main": [
        [
          {
            "node": "ì„±ê³µ ì‘ë‹µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "timezone": "Asia/Bangkok"
  },
  "versionId": "1",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "bookmakgol-reservation-intake",
  "tags": []
}
